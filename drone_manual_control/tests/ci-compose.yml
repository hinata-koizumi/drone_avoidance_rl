version: '3.8'

services:
  # メッセージ定義ビルド（CI用）
  drone_msgs_ci:
    build:
      context: ..
      dockerfile: docker/Dockerfile.msgs
    volumes:
      - ../src/drone_msgs:/workspace/src/drone_msgs:ro
      - ../src/px4_msgs:/workspace/src/px4_msgs:ro
      - ../install:/workspace/install
    environment:
      - COLCON_OPTIONS=--packages-select drone_msgs px4_msgs
    command: colcon build --event-handlers console_direct+
    profiles: ["ci"]

  # ブリッジノードビルド（CI用）
  bridge_ci:
    build:
      context: ..
      dockerfile: docker/Dockerfile.bridge
    volumes:
      - ../src:/workspace/src:ro
      - ../install:/workspace/install
      - ../config:/workspace/config:ro
    environment:
      - COLCON_OPTIONS=--packages-select common command_bridge state_bridge angle_bridge outer_motor_bridge
    depends_on:
      - drone_msgs_ci
    command: colcon build --event-handlers console_direct+
    profiles: ["ci"]

  # 手動制御ノード（CI用）
  manual_control_ci:
    build:
      context: ..
      dockerfile: drone_manual_control/docker/Dockerfile.manual_control
    volumes:
      - ../src/manual_control:/workspace/src/manual_control:ro
      - config:/workspace/config:ro
    environment:
      - COLCON_OPTIONS=--packages-select manual_control
    depends_on:
      - bridge_ci
    command: |
      bash -c "
        source /opt/ros/humble/setup.bash
        colcon build --packages-select manual_control
        echo 'Manual control package built successfully'
      "
    profiles: ["ci"]

  # テスト実行（CI用）
  test_runner:
    build:
      context: ..
      dockerfile: drone_manual_control/docker/Dockerfile.manual_control
    volumes:
      - ../src/manual_control:/workspace/src/manual_control:ro
      - config:/workspace/config:ro
      - ./test-results:/workspace/test-results
    environment:
      - COLCON_OPTIONS=--packages-select manual_control
    depends_on:
      - manual_control_ci
    command: |
      bash -c "
        source /opt/ros/humble/setup.bash
        source install/setup.bash
        python -m pytest tests/ -v --junitxml=test-results/results.xml
        echo 'Tests completed'
      "
    profiles: ["ci"]

volumes:
  config:
    driver: local 