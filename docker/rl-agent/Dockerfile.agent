# docker/rl-agent/Dockerfile.agent   2025-04-30 R3
FROM base AS builder
USER root

# ---------- Python env ----------
COPY docker/rl-agent/requirements.lock /tmp/requirements.lock
RUN source /opt/venv/bin/activate && \
    pip install --no-cache-dir -r /tmp/requirements.lock

# ---------- build workspace ----------
WORKDIR /drone_ws
RUN mkdir -p src
COPY src/                 src/
COPY drone_msgs/          drone_msgs/
# message packageだけビルドして site-packages へ
RUN . /opt/ros/humble/setup.sh && \
    colcon build --packages-select drone_msgs && \
    . install/setup.sh

# ---------- runtime ----------
FROM base
USER root
# runtime 依存
RUN apt-get update && \
    apt-get install -y --no-install-recommends ignition-tools netcat-openbsd && \
    apt-get clean && rm -rf /var/lib/apt/lists/*
COPY --from=builder /opt/venv /opt/venv
COPY --from=builder /drone_ws /drone_ws
ENV PATH="/opt/venv/bin:$PATH" PYTHONUNBUFFERED=1
WORKDIR /drone_ws
USER px4user
ENTRYPOINT ["python3", "src/train_agent.py"]
